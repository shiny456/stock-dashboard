import streamlit as st
import yfinance as yf
import pandas_ta as ta
import pandas as pd

# ====================================================
# 1. çŸ¥è­˜è¤‡ç¿’å€å…§å®¹ (ç”¨æˆ¶æä¾› - investment_notes_full)
# ====================================================

investment_notes_full = {
    "title": "è‚¡å”å¯¦æˆ°å¿ƒæ³•ï¼šA+è³‡ç”¢é‡‘å­—å¡”ä½ˆå±€èˆ‡éµè¡€ç´€å¾‹",
    "sections": [
        {
            "heading": "0. æ ¸å¿ƒæ¦‚å¿µèˆ‡çµè«–",
            "points": [
                "æ–‡ç« å®—æ—¨ï¼šå­¸ç¿’åœ¨é ‚ç´šè³‡ç”¢ä¸Šé€²è¡Œæœ‰ç´€å¾‹çš„ã€Œå·¦å´ã€é‡‘å­—å¡”ä½ˆå±€ï¼Œä¸¦æ­é…éµè¡€æ­¢æç´€å¾‹ã€‚",
                "ä¸‰å¤§åŸå‰‡ï¼šæŒ‘é¸ A+ è³‡ç”¢ã€è¨­å¥½æ’¤é€€è¨ˆç•«ã€åŸ·è¡Œæ··åˆä½ˆå±€ã€‚",
                "çµè«–ï¼šè¿½æ±‚æœ€é«˜çš„ç¢ºå®šæ€§ï¼ˆå³å´è¶¨å‹¢ï¼‰ï¼Œè€Œéæœ€ä½çš„æˆæœ¬ï¼›ç´€å¾‹æ˜¯ç”Ÿå­˜çš„å”¯ä¸€ä¿è­‰ã€‚"
            ]
        },
        {
            "heading": "1. æˆ°å‰æº–å‚™ï¼šé¸å¥½ä½ çš„æˆ°å ´ï¼ˆA+ è³‡ç”¢ç¯©é¸ï¼‰",
            "points": [
                "**ç›®æ¨™**ï¼šæ‰¾æœªä¾†äº”åˆ°åå¹´æ”¾è‘—ä¸æ“”å¿ƒçš„é ‚ç´šã€Œé¾é ­è‚¡ã€ï¼Œé€™æ¯”ä½ è€å©†ç”Ÿæ—¥é‚„é‡è¦ï¼ˆé€™æ˜¯ç”Ÿå­˜å•é¡Œï¼‰ã€‚",
                "**å …ä¸å¯æ‘§çš„ã€Œè­·åŸæ²³ã€**ï¼šå¿…é ˆæ“æœ‰è¿‘ä¹å£Ÿæ–·çš„ç«¶çˆ­å„ªå‹¢ï¼ˆæŠ€è¡“å°ˆåˆ©ã€ç¶²è·¯æ•ˆæ‡‰ã€åœ‹å®¶æˆ°ç•¥ï¼‰ã€‚è­·åŸæ²³è£¡è¦æœ‰é±·é­šã€é£Ÿäººé­šï¼Œé‚„è¦æ‹‰é«˜å£“é›»ç¶²ã€‚",
                "ç¯„ä¾‹ï¼šTSMï¼ˆåœ‹å®¶æˆ°ç•¥é›£ä»¥è¤‡è£½ï¼‰ã€NVDA CUDAï¼ˆæ‰€æœ‰é–‹ç™¼è€…éƒ½åœ¨ä¸Šé¢ï¼Œè½‰æ›ç—›è‹¦ï¼‰ã€‚",
                "**å ¡å£˜èˆ¬çš„ã€Œè³‡ç”¢è² å‚µè¡¨ã€**ï¼šç¾é‡‘å……è£•ã€è² å‚µæ¥µä½ã€‚ç¾é‡‘å¿…é ˆé é å¤§æ–¼çŸ­æœŸè² å‚µï¼Œç”šè‡³æœ€å¥½èƒ½è¦†è“‹ç¸½è² å‚µï¼Œç¢ºä¿ç¶“æ¿Ÿè¡°é€€ä¸‰å¹´ä¹Ÿèƒ½æ´»ä¸‹ä¾†ã€‚",
                "**æ„ç¾©**ï¼šé€™æ˜¯ã€Œè´å®¶é€šåƒã€çš„æœ¬éŒ¢ï¼Œèƒ½è¶æ©Ÿä¾¿å®œæ”¶è³¼å¿«é¤“æ­»çš„ç«¶çˆ­å°æ‰‹ã€‚",
                "**æ¸…æ™°å¯è¦‹çš„ã€Œé•·æœŸåŠ‡æœ¬ã€**ï¼šèƒ½åˆ†æ¸…ã€ŒçŸ­æœŸé€†é¢¨ã€ï¼ˆåŸºæœ¬ç›¤æœªè®Šï¼Œå¦‚ META é¢å° ATT æ‰“æ“Šï¼‰èˆ‡ã€Œé•·æœŸè¡°é€€ã€ï¼ˆè¢«æ™‚ä»£æ·˜æ±°ï¼Œå¦‚ KODKï¼‰ã€‚"
            ]
        },
        {
            "heading": "2. æˆ°å‰æº–å‚™ï¼šè¨­å®šæ’¤é€€è¨ˆç•«ï¼ˆæ­¢æçš„éµè¡€ç´€å¾‹ï¼‰",
            "points": [
                "**æ­¢è™§æ˜¯ç´€å¾‹ï¼Œä¸æ˜¯è—è¡“**ã€‚å¤šæ•¸äººè³ å…‰ä¸æ˜¯å› ç‚ºçœ‹éŒ¯ï¼Œè€Œæ˜¯çœ‹éŒ¯äº†é‚„ä¸è‚¯èµ°ï¼ˆä¸é¡˜ã€Œå¯¦ç¾ã€è™§æï¼‰ã€‚",
                "**æ ¸å¿ƒç›®çš„**ï¼šä¿ä½ä½ çš„æœ¬é‡‘ï¼Œè®“ä½ æ˜å¤©é‚„æœ‰å­å½ˆä¸Šæˆ°å ´ã€‚",
                "**æ–°æ‰‹ç´šï¼ˆå›ºå®š %ï¼‰**ï¼šå®¹æ˜“è¢«ã€Œæ´—å‡ºå ´ã€ï¼ˆWhipsawedï¼‰ï¼Œå‰è…³å‰›è³£å¾Œè…³å°±æ¼²ï¼Œä¸å°Šé‡è‚¡ç¥¨æ³¢å‹•ç‡ã€‚",
                "**é€²éšç´šï¼ˆæŠ€è¡“æŒ‡æ¨™ï¼‰**ï¼šè®“å¸‚å ´å®¢è§€è¨Šè™Ÿå‘Šè¨´ä½ è¶¨å‹¢ä¸å°ã€‚",
                "**è¨Šè™Ÿ**ï¼šæ˜ç¢ºè·Œç ´ **50 æ—¥å‡ç·š**ï¼ˆä¸­æœŸç”Ÿå‘½ç·šï¼‰æˆ– **200 æ—¥å‡ç·š**ï¼ˆç‰›ç†Šåˆ†ç•Œç·šï¼‰ï¼Œæˆ–é—œéµæ”¯æ’ä½ï¼ˆå¤šé ­èˆ‡ç©ºé ­çš„é˜²ç·šè¢«æ”»ç ´ï¼‰ã€‚",
                "**é«˜æ‰‹ç´šï¼ˆåŸºæœ¬é¢åœæï¼‰**ï¼šä½ çš„æ­¢æé»æ˜¯ç•¶åˆè²·å…¥çš„ã€Œç†ç”±ã€ã€‚åªè¦ã€Œè­·åŸæ²³ã€è³‡ç”¢è² å‚µè¡¨ã€é•·æœŸåŠ‡æœ¬ã€é€™ä¸‰é»ä¸è®Šï¼Œå°±å¿å—çŸ­æœŸçš„æŠ€è¡“æ³¢å‹•ã€‚ä¸€æ—¦æ”¹è®Šï¼Œ**ç«‹åˆ»ç å€‰**ã€‚",
                "**åŸ·è¡Œ**ï¼šç å€‰è¦æ‹”å¾—åˆå¿«ã€åˆç‹ ã€åˆæº–ï¼Œæ‹”å¾—å¤ªæ…¢å°±å®¹æ˜“ç•¶çˆ¸çˆ¸ã€‚"
            ]
        },
        {
            "heading": "3. æˆ°æ™‚éƒ¨ç½²ï¼šé‡‘å­—å¡”å¼æ··åˆç­–ç•¥ (V3.0)",
            "points": [
                "**ç­–ç•¥ç²¾é«“**ï¼šçµåˆäº†ã€Œå·¦å´ã€çš„å‹‡æ°£å’Œã€Œå³å´ã€çš„æ™ºæ…§ã€‚",
            ],
            "subsections": [
                {
                    "sub_heading": "ç¬¬ä¸€éšæ®µï¼šéƒ¨ç½²ã€Œåµå¯Ÿå…µã€ï¼ˆå·¦å´ä½ˆå±€ï¼‰",
                    "sub_points": [
                        "æ™‚æ©Ÿï¼šè‚¡åƒ¹ä½æ–¼ã€Œé»ƒé‡‘å‘ã€ã€å¸‚å ´ä¸€ç‰‡æ‚²è§€æ™‚ï¼Œæ–°èé ­æ¢éƒ½æ˜¯å£æ¶ˆæ¯ã€‚",
                        "å‹•ä½œï¼šåŸ·è¡Œã€Œå°é¡ã€åˆ†æ‰¹ã€æ‹‰é•·é€±æœŸã€çš„ DCAã€‚",
                        "è³‡é‡‘ï¼šç¸½é ç®—åƒ…ä½”ç¸½è¨ˆç•«å€‰ä½çš„ 10-12%ï¼ˆåµå¯Ÿå…µä¸æ˜¯ä¸»åŠ›éƒ¨éšŠï¼‰ã€‚",
                        "å¿ƒæ…‹ï¼šç›®çš„åªæ˜¯æ‹¿åˆ°ã€Œå…¥å ´åˆ¸ã€ï¼Œåšå¥½äº†å€‰ä½å¯èƒ½é‚„æœƒå†è·Œ 20% çš„å¿ƒç†æº–å‚™ã€‚é€™å«**æœ‰ç´€å¾‹çš„æ”¤å¹³**ã€‚"
                    ]
                },
                {
                    "sub_heading": "ç¬¬äºŒéšæ®µï¼šæŠ•å…¥ã€Œä¸»åŠ›éƒ¨éšŠã€ï¼ˆå³å´è¿½æ“Šï¼‰",
                    "sub_points": [
                        "æ™‚æ©Ÿï¼šè€å¿ƒç­‰å¾…ä¸€å€‹æ˜ç¢ºçš„ã€Œåè½‰è¨Šè™Ÿã€ï¼ˆè™Ÿè§’å¹éŸ¿ï¼‰ã€‚å¤§å¤šæ•¸æ•£æˆ¶åœ¨å·¦å´å°±æŠŠå­å½ˆæ‰“å…‰äº†ã€‚",
                        "æŠ€è¡“è¨Šè™Ÿï¼š**ç«™ç©© 200 æ—¥å‡ç·šä¸¦ä¸Šå½**ï¼ˆæœ€å¸¸ç”¨è¨Šè™Ÿï¼‰ï¼Œæˆ– 50 æ—¥å‡ç·šé»ƒé‡‘äº¤å‰ 200 æ—¥å‡ç·šã€‚",
                        "å‹•ä½œï¼šä¸€æ—¦éŸ¿èµ·ï¼Œæœæ–·å°‡ä¸»åŠ›éƒ¨éšŠï¼ˆå‰©é¤˜ 30-50% è³‡é‡‘ï¼‰æŠ•å…¥èµ·æ¼²é»ã€‚",
                        "å¿ƒæ…‹ï¼šå¹³å‡æˆæœ¬æœƒè¢«æ‹‰é«˜ï¼Œä½†è¿½æ±‚çš„æ˜¯**æœ€é«˜çš„ç¢ºå®šæ€§**ï¼Œè€Œä¸æ˜¯æœ€ä½æˆæœ¬ã€‚"
                    ]
                }
            ]
        },
        {
            "heading": "4. é—œéµæˆ°å½¹ï¼šå¦‚ä½•æ‡‰å°ã€Œè²¡å ±ã€ï¼Ÿ",
            "points": [
                "**æ ¸å¿ƒèªçŸ¥**ï¼šè²¡å ±æ—¥æ˜¯ã€Œè³­å ´ã€ã€‚æ±ºå®šæ¼²è·Œçš„æ˜¯ã€Œæ¥­ç¸¾ vs. å¸‚å ´è®Šæ…‹çš„è¶…é«˜é æœŸã€ã€‚ä½ åªæ˜¯æ•£æˆ¶ï¼Œç©ä¸éä»–å€‘ã€‚",
                "**é•·ç·šæŠ•è³‡è€…ï¼ˆA+è³‡ç”¢ï¼‰**ï¼š**æŠ±è‘—ä¸å‹•**ï¼ˆHoldï¼‰ã€‚ä½ è²·å…¥æ˜¯ç‚ºäº†æœªä¾† 5~10 å¹´ã€‚è‹¥å› è²¡å ±ä¸‹è·Œï¼Œåªè¦åŸºæœ¬é¢åœæç†ç”±æœªå‡ºç¾ï¼Œå°±æ˜¯**å·¦å´è£œå€‰æ©Ÿæœƒ**ã€‚",
                "**äº¤æ˜“è€…ï¼ˆå·²ç²åˆ©ï¼‰**ï¼š**æ¨è–¦ï¼šè³£å‡ºä¸€åŠ (Trim Half)**ã€‚åœ¨è²¡å ±å‰ä¸€å¤©æ”¶ç›¤è³£æ‰ 1/2ï¼Œæ‹¿å›æˆæœ¬èˆ‡éƒ¨åˆ†åˆ©æ½¤ï¼Œç”¨é›¶æˆæœ¬çš„ã€Œåˆ©æ½¤è‚¡ã€å»è³­è²¡å ±ï¼Œé”åˆ°ã€Œå¤§å”çš„ç¡å¾—è‘—è¦ºç­–ç•¥ã€ã€‚",
                "**è­¦æƒ•**ï¼šæ°¸é ä¸è¦çœ‹ä¸èµ·ã€Œå·²å¯¦ç¾ã€çš„ç²åˆ©ï¼ˆã€Œè±¬é¤Šè‚¥äº†ï¼Œå°±æ˜¯è¦æ®ºçš„ã€ï¼‰ã€‚",
                "**åš´æ ¼ç¦æ­¢**ï¼šå¦‚æœä½ é‚„æ²’é€²å ´ï¼Œæƒ³ã€Œè³­ã€è²¡å ±ã€‚é€™æ˜¯ 100% çš„è³­åšï¼Œä¸è¦ç”¨è¾›è‹¦éŒ¢å»è³­ä¸€å€‹ã€Œæ¥­ç¸¾ç›²ç›’ã€ã€‚"
            ]
        }
    ]
}

# ====================================================
# 2. å‡½æ•¸å€
# ====================================================

# ç”¨æ–¼é¡¯ç¤ºç­†è¨˜çš„å…§å®¹
def display_investment_notes(notes, selected_heading):
    """æ ¹æ“šé¸å®šçš„æ¨™é¡Œï¼Œé¡¯ç¤ºå°æ‡‰çš„ç­†è¨˜å…§å®¹ã€‚"""
    st.title(notes['title'])
    st.markdown("---")
    
    for section in notes['sections']:
        if section['heading'] == selected_heading:
            
            st.header(section['heading'])
            
            if 'points' in section:
                for point in section['points']:
                    st.markdown(f"- {point}")
            
            if 'subsections' in section:
                for subsection in section['subsections']:
                    st.subheader(subsection['sub_heading'])
                    for point in subsection['sub_points']:
                        st.markdown(f"- {point}")
            break


# æ‚¨çš„å®¢è£½åŒ–ã€Œå¤§ç¥ã€ç­–ç•¥åˆ¤æ–·å€
# ç‚ºäº†è¦–è¦ºåŒ–æ‹†è§£ï¼Œæˆ‘å€‘è®“é€™å€‹å‡½æ•¸è¿”å›æ›´å¤šç´°ç¯€
def generate_custom_judgement(price, ma50, ma200, pe, rsi):
    """çµåˆæŠ€è¡“é¢å’ŒåŸºæœ¬é¢ï¼Œçµ¦å‡ºæœ€çµ‚åˆ¤æ–·ï¼Œä¸¦è¿”å›è©³ç´°åˆ¤æ–·çµæœã€‚"""
    
    # è¦å‰‡å®šç¾©ï¼š
    # Rule 1: è¶¨å‹¢åˆ¤æ–· (Trend Filter) - åƒ¹æ ¼å¿…é ˆåœ¨ 200MA ä¹‹ä¸Š
    trend_ok = (price > ma200)
    
    # Rule 2: åƒ¹å€¼åˆ¤æ–· (Value Filter) - P/E ä½æ–¼ 25 å€ (é¿å…é«˜ä¼°å€¼)
    pe_val = float(pe) if pe != 'ç„¡' else 999 
    value_ok = (pe != 'ç„¡' and pe_val < 25)

    # Rule 3: çŸ­æœŸå‹•èƒ½ (RSI) - é¿å… RSI éç†± (> 70)
    rsi_ok = (rsi < 70)
    
    # çµåˆåˆ¤æ–·
    if trend_ok and value_ok and rsi_ok:
        final_judgement = "ğŸŒŸ å¤§å¸«è²·å…¥å€é–“ï¼šè¶¨å‹¢å¼·å‹ã€ä¼°å€¼åˆç†ã€å‹•èƒ½æœªéç†±ï¼"
        signal_color = "success"
    elif trend_ok and not rsi_ok:
        final_judgement = "âš ï¸ è¶¨å‹¢å¼·å‹ï¼Œä½† RSI éç†± ( > 70)ï¼Œå°å¿ƒçŸ­ç·šæ‹‰å›ã€‚"
        signal_color = "warning"
    elif not trend_ok and value_ok:
        final_judgement = "ğŸ“‰ åƒ¹å€¼ä½ä¼°ä½†è¶¨å‹¢åå¼±ï¼Œé©åˆé•·æœŸè§€å¯Ÿæˆ–å·¦å´åˆ†æ‰¹ã€‚"
        signal_color = "info"
    else:
        final_judgement = "ğŸš§ è¨Šè™Ÿä¸ç¢ºå®šï¼Œä¿æŒè§€æœ›æˆ–ç­‰å¾…æ˜ç¢ºå³å´è¨Šè™Ÿã€‚"
        signal_color = "error"
        
    # è¿”å›æœ€çµ‚çµè«–å’Œè©³ç´°åˆ¤æ–·
    return final_judgement, signal_color, trend_ok, value_ok, rsi_ok


# ====================================================
# 3. é é¢ä½ˆå±€èˆ‡ä¸»é«”é‚è¼¯
# ====================================================

st.set_page_config(page_title="è‚¡ç¥¨æŠ•è³‡ç™½è©±å„€è¡¨æ¿", layout="wide")

# --- å´é‚Šæ¬„æ§åˆ¶é … ---
with st.sidebar:
    st.header("âš™ï¸ æ¨¡å¼åˆ‡æ›èˆ‡åƒæ•¸è¨­å®š")

    # æ¨¡å¼åˆ‡æ›
    mode = st.radio(
        "è«‹é¸æ“‡å„€è¡¨æ¿æ¨¡å¼",
        ("è‚¡ç¥¨åˆ†æ", "æ–‡ç« è¤‡ç¿’"),
        index=0 
    )
    
    st.divider()

    # è‚¡ç¥¨åˆ†æåƒæ•¸
    if mode == "è‚¡ç¥¨åˆ†æ":
        st.subheader("ğŸ” æŸ¥è©¢è¨­å®š")
        ticker = st.text_input("è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ", value="NVDA").upper()
        st.caption("è«‹ç›´æ¥è¼¸å…¥ç¾è‚¡ä»£è™Ÿ (å¦‚ NVDA, AAPL, TSM)ã€‚") 
        run_btn = st.button("é–‹å§‹åˆ†æ")
    else:
        # æ–‡ç« è¤‡ç¿’é¸å–®
        st.subheader("ğŸ“š è¤‡ç¿’é‡é»é¸å–®")
        review_options = [s['heading'] for s in investment_notes_full['sections']]
        review_selection = st.radio(
            "è«‹é¸æ“‡ç­†è¨˜ç« ç¯€",
            review_options,
            index=0
        )
        ticker = None 
        run_btn = False


# --- ä¸»é«”å…§å®¹é¡¯ç¤º ---

if mode == "æ–‡ç« è¤‡ç¿’":
    display_investment_notes(investment_notes_full, review_selection)

elif mode == "è‚¡ç¥¨åˆ†æ":
    st.title(f"ğŸ“ˆ è‚¡ç¥¨åŸºæœ¬é¢èˆ‡è¶¨å‹¢åˆ†æ: {ticker}")
    
    if run_btn:
        with st.spinner(f'æ­£åœ¨åˆ†æ {ticker}...'):
            try:
                # æŠ“å–è³‡æ–™
                stock = yf.Ticker(ticker)
                # ä½¿ç”¨ 1 å¹´æœŸç²å–è¶³å¤ çš„ 200MA æ•¸æ“š
                df = stock.history(period="1y") 
                info = stock.info
                
                if df.empty:
                    st.error("âŒ æ‰¾ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªä»£è™Ÿæ˜¯å¦æ­£ç¢ºï¼")
                    st.stop()
                
                # --- æ–°å¢æŒ‡æ¨™è¨ˆç®— ---
                price = df['Close'].iloc[-1]
                change = price - df['Close'].iloc[-2]
                ma50 = df['Close'].rolling(50).mean().iloc[-1]
                ma200 = df['Close'].rolling(200).mean().iloc[-1] 
                pe = info.get('trailingPE', 'ç„¡')
                
                # 52 é€±é«˜ä½é»
                high_52w = info.get('fiftyTwoWeekHigh', df['Close'].max())
                low_52w = info.get('fiftyTwoWeekLow', df['Close'].min())
                
                # è¨ˆç®—ç›¸å°ä½éš (é¿å…é™¤ä»¥é›¶)
                if (high_52w - low_52w) > 0.01:
                    position_52w = ((price - low_52w) / (high_52w - low_52w)) * 100
                else:
                    position_52w = 0 # è‚¡åƒ¹æ²’æœ‰æ³¢å‹•æˆ–æ•¸æ“šç¼ºå¤±
                
                # ç°¡æ˜“è²¡å‹™æª¢æŸ¥ (è² å‚µæ¬Šç›Šæ¯”)
                debt_equity = info.get('debtToEquity', 'ç„¡') # å–®ä½æ˜¯ç™¾åˆ†æ¯” (e.g., 50.0)

                # è¨ˆç®— BBands, MACD, RSI
                bbands = df.ta.bbands(length=20, std=2.0, append=True) 
                macd_data = df.ta.macd(close='Close')
                rsi = df.ta.rsi(close='Close').iloc[-1]


                # --- é¡¯ç¤ºåŸºæœ¬ metrics (6 æ¬„ä½) ---
                st.subheader("ğŸ“Š é—œéµè²¡å‹™èˆ‡æŠ€è¡“æŒ‡æ¨™")
                col1, col2, col3, col4, col5, col6 = st.columns(6)
                col1.metric("ç›®å‰è‚¡åƒ¹", f"${price:.2f}", f"{change:.2f}")
                col2.metric("50æ—¥å‡ç·š", f"${ma50:.2f}")
                col3.metric("200æ—¥å‡ç·š", f"${ma200:.2f}") 
                col4.metric("RSI (14)", f"{rsi:.1f}")
                col5.metric("æœ¬ç›Šæ¯” PE", f"{pe}")
                
                # è² å‚µå¥åº·ç‹€æ…‹
                debt_status_val = f"{debt_equity:.1f}%" if isinstance(debt_equity, (int, float)) else "ç„¡æ•¸æ“š"
                if isinstance(debt_equity, (int, float)) and debt_equity > 150: # è² å‚µæ¬Šç›Šæ¯” > 150% è¦–ç‚ºåé«˜
                    debt_status_delta = "åé«˜ (> 150%)"
                    debt_status_color = "inverse"
                else:
                    debt_status_delta = "è‰¯å¥½"
                    debt_status_color = "off"
                col6.metric("è² å‚µæ¬Šç›Šæ¯”", debt_status_val, debt_status_delta, delta_color=debt_status_color)
                
                # --- æ–°å¢ 52 é€±ä½éšåˆ†æ ---
                st.markdown("##### ğŸ“ åƒ¹æ ¼ç›¸å°ä½éšåˆ†æ")
                col_52_1, col_52_2, col_52_3 = st.columns(3)
                col_52_1.metric("52 é€±é«˜é»", f"${high_52w:.2f}")
                col_52_2.metric("52 é€±ä½é»", f"${low_52w:.2f}")
                
                # ä½éšé¡è‰²åˆ¤æ–·: é«˜æ–¼ 80% è­¦å‘Šè¿½é«˜, ä½æ–¼ 20% è­¦å‘Šä¸‹è·Œ
                if position_52w > 80:
                    delta_color = "inverse"
                elif position_52w < 20:
                    delta_color = "normal" 
                else:
                    delta_color = "off"

                col_52_3.metric("ç›®å‰ç›¸å°ä½éš", f"{position_52w:.1f}%", help="ï¼ˆç›®å‰åƒ¹ç›¸å°æ–¼ 52 é€±ä½é»åˆ°é«˜é»çš„ç™¾åˆ†æ¯”ä½ç½®ï¼‰", delta_color=delta_color)

                st.divider()
                
                # --- è‡ªå®šç¾©ç­–ç•¥è¨Šè™Ÿ èˆ‡ è¦–è¦ºåŒ–æ‹†è§£ ---
                judgement_txt, color_status, trend_ok, value_ok, rsi_ok = generate_custom_judgement(price, ma50, ma200, pe, rsi)
                st.subheader("ğŸ’¡ æ‚¨çš„å®¢è£½åŒ–ã€Œå¤§ç¥ã€ç­–ç•¥è¨Šè™Ÿ")
                
                if color_status == "success":
                    st.success(judgement_txt)
                elif color_status == "warning":
                    st.warning(judgement_txt)
                elif color_status == "info":
                    st.info(judgement_txt)
                else:
                    st.error(judgement_txt)
                
                # ç­–ç•¥å‚™è¨»
                st.caption(
                    "ç›®å‰çš„ç­–ç•¥å®šç¾©ï¼š**è¶¨å‹¢** (åƒ¹æ ¼ > 200MA)ã€**åƒ¹å€¼** (P/E < 25)ã€**å‹•èƒ½** (RSI < 70)ã€‚"
                )

                # è¦–è¦ºåŒ–æ‹†è§£
                st.markdown("##### ğŸ“ æ¢ä»¶é”æˆç´°ç¯€")
                col_c1, col_c2, col_c3 = st.columns(3)
                
                col_c1.markdown(f"**è¶¨å‹¢éæ¿¾ (200MA)ï¼š** {'âœ… é”æˆ' if trend_ok else 'âŒ æœªé”æˆ'}")
                col_c2.markdown(f"**åƒ¹å€¼éæ¿¾ (PE < 25)ï¼š** {'âœ… é”æˆ' if value_ok else 'âŒ æœªé”æˆ'}")
                col_c3.markdown(f"**å‹•èƒ½éæ¿¾ (RSI < 70)ï¼š** {'âœ… é”æˆ' if rsi_ok else 'âŒ æœªé”æˆ'}")

                st.divider()

                # --- èµ°å‹¢åœ–èˆ‡æŒ‡æ¨™åœ– ---
                
                # 1. ä¸»åœ–å€ (è‚¡åƒ¹, 50MA, 200MA, BBands)
                st.subheader("ğŸ“ˆ è‚¡åƒ¹èµ°å‹¢åœ– (å«å‡ç·šèˆ‡å¸ƒæ—é€šé“)")
                chart_data = df[['Close']].copy()
                chart_data['50MA'] = df['Close'].rolling(50).mean()
                chart_data['200MA'] = df['Close'].rolling(200).mean()
                
                if 'BBU_20_2.0' in df.columns:
                    chart_data['BB_Upper'] = df['BBU_20_2.0'] 
                    chart_data['BB_Lower'] = df['BBL_20_2.0']
                    st.caption("å¸ƒæ—é€šé“å·²ç¹ªè£½ã€‚")
                else:
                    st.warning("âš ï¸ è­¦å‘Šï¼šå¸ƒæ—é€šé“ (BBands) è³‡æ–™ä¸è¶³æˆ–è¨ˆç®—å¤±æ•—ï¼Œå·²è·³éç¹ªè£½ã€‚")
                
                st.line_chart(chart_data)


                # 2. MACD å‰¯åœ–å€
                st.subheader("ğŸ“Š MACD æŒ‡æ¨™åœ–")
                st.caption(
                    "å®šç¾©ï¼š**å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·š**ã€‚çœ‹é»ï¼š**MACD ç·š**ï¼ˆå¿«ç·šï¼‰ä¸Šç©¿ **Signal ç·š**ï¼ˆæ…¢ç·šï¼‰ç‚ºé‡‘å‰ï¼ˆè²·å…¥ï¼‰ï¼ŒMACD ç·šä¸‹ç©¿ Signal ç·šç‚ºæ­»å‰ï¼ˆè³£å‡ºï¼‰ã€‚æŒ‡æ¨™ç·šé è¿‘é›¶è»¸ä»£è¡¨éœ‡ç›ªæ•´ç†ã€‚"
                )
                macd_chart_data = macd_data[['MACD_12_26_9', 'MACDh_12_26_9', 'MACDs_12_26_9']].copy()
                macd_chart_data.columns = ['MACD Line', 'Histogram', 'Signal Line']
                st.line_chart(macd_chart_data)
                
                # 3. RSI å‰¯åœ–å€
                st.subheader("ğŸ“ˆ RSI (ç›¸å°å¼·å¼±æŒ‡æ¨™)")
                st.caption(
                    "å®šç¾©ï¼š**ç›¸å°å¼·å¼±æŒ‡æ¨™**ã€‚è¡¡é‡è²·è³£é›™æ–¹åŠ›é‡çš„å¼·å¼±ã€‚çœ‹é»ï¼š**RSI > 70** ç‚ºè¶…è²·ï¼ˆçŸ­ç·šæ˜“æ‹‰å›ï¼‰ï¼Œ**RSI < 30** ç‚ºè¶…è³£ï¼ˆçŸ­ç·šæ˜“åå½ˆï¼‰ã€‚"
                )
                st.line_chart(df.ta.rsi(close='Close'))
                
                st.divider()
                
                # --- æ–°èå€ ---
                st.subheader(f"ğŸ—ï¸ {ticker} æœ€æ–°æ–°è (è‹±æ–‡)")

                try:
                    news_data = stock.news 
                    
                    if news_data:
                        for i, article in enumerate(news_data[:5]):
                            title = article.get('title', 'æ¨™é¡Œéºå¤±')
                            link = article.get('link', '#')
                            publisher = article.get('publisher', 'æœªçŸ¥ä¾†æº')
                            
                            st.markdown(f"**[{title}]({link})**")
                            st.caption(f"ä¾†æºï¼š{publisher}")
                    else:
                        st.info("æš«ç„¡ç›¸é—œæ–°èè³‡è¨Šã€‚")

                except Exception as news_e:
                    st.error(f"âŒ æ–°èè³‡æ–™æŠ“å–å¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: {news_e}")


            except Exception as e:
                st.error(f"ç™¼ç”ŸéŒ¯èª¤ï¼šè«‹æª¢æŸ¥ä»£è™Ÿæ˜¯å¦æ­£ç¢ºã€‚éŒ¯èª¤è¨Šæ¯: {e}")
